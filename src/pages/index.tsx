import getCurrentUser from "@/actions/getCurrentUser";
import getRoomsData from "@/actions/getRoomsData";
import Categories from "@/components/Navbar/Categories";
import CarouselRoomCard from "@/components/shared/rooms/RoomCard";
import {
  Container,
  Grid,
  Box,
  AppBar,
  Typography,
  Button,
} from "@mui/material";
import Head from "next/head";
import { useInfiniteQuery } from "@tanstack/react-query";
import axios from "axios";

/* 
 TODO: Zvolit správné typování místo any
*/

export default function Home({ rooms, currentUser }: any) {
  const { data, fetchNextPage, isFetchingNextPage } = useInfiniteQuery(
    ["rooms"],
    async ({ pageParam = 0 }) => {
      console.log("I was called");
      const response = await axios.get(`/api/get-rooms?page=${pageParam + 1}`);
      return response.data;
    },
    {
      getNextPageParam: (_, pages) => {
        return pages.length + 1;
      },
    }
  );
  console.log(data?.pages);

  return (
    <>
      <Head>
        <title>Vacation Homes & Condo Rentals - Airbnb</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/airbnb-icon.svg" />
      </Head>
      <main>
        <Container sx={{ my: "3rem", paddingBottom: "5rem" }}>
          <Grid
            container
            rowSpacing={1}
            columnSpacing={{ xs: 1, sm: 2, md: 3 }}
            px={"2rem"}
            sx={{
              justifyContent: { xs: "center", md: "flex-start" },
            }}
          >
            {data?.pages.map((room: any) => (
              <Grid item xs={12} sm={6} md={4} key={room.id}>
                <CarouselRoomCard data={room} currentUser={currentUser} />
              </Grid>
            ))}
          </Grid>
          <Button onClick={() => fetchNextPage()}>
            {isFetchingNextPage
              ? "Loading More..."
              : (data?.pages.length ?? 0) < 3
              ? "Load more"
              : "Nothing more to load"}
          </Button>
          <Box sx={{ my: 2 }}>
            {[...new Array(12)]
              .map(
                () => `Cras mattis consectetur purus sit amet fermentum.
Cras justo odio, dapibus ac facilisis in, egestas eget quam.
Morbi leo risus, porta ac consectetur ac, vestibulum at eros.
Praesent commodo cursus magna, vel scelerisque nisl consectetur et.`
              )
              .join("\n")}
          </Box>
        </Container>
      </main>
    </>
  );
}

export async function getServerSideProps({ req, res }: any) {
  const rooms = await getRoomsData(1);
  const currentUser = await getCurrentUser(req, res);

  return {
    props: {
      rooms,
      currentUser,
    },
  };
}
